{% extends 'base.html' %} 

{% block content %}

<div>
    <!-- Header -->
    {% include 'header.html' %}
    <!-- Featured books -->
    <div>
        <h1 class="font-bold text-3xl mx-[50px] my-[20px]">For You</h1>
        <div class="flex justify-center items-center">
            <div id="featured_books" class="flex flex-col lg:flex-row w-full h-auto lg:h-[250px] items-center gap-3 overflow-x-auto snap-x snap-normal snap-mandatory">
                <!-- Coded in javascript -->
            </div>
        </div>
    </div>
    <!-- Browse books -->
    <div class="flex flex-col mt-[30px] mb-[60px]">
        <h1 class="font-bold text-2xl mx-[50px]">Browse</h1>
        <div class="flex flex-col justify-center items-center my-5 gap-1">
            <h1 class="font-bold text-lg">Search your books here!</h1>
            <input id="search_input" type="text" class="rounded-xl bg-gray-200 w-[300px] lg:w-[350px] h-[40px] px-3 py-1 border-black border" placeholder="The title..." value="" autocomplete="off">
        </div>
        <div id="browse_books" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 2xl:grid-cols-4 w-full h-auto items-center justify-center justify-items-center gap-4 px-[50px] py-2">
            <!-- Coded in javascript -->
        </div>
    </div>
</div>

<script>
    const featured_book_ids = [3, 7, 6, 68, 32];
    const featured_book_colors = {
        3: 'from-indigo-800 to-indigo-400', 
        6: 'from-red-600 to-red-300', 
        7: 'from-sky-500 to-sky-200',
        68: 'from-green-700 to-green-500',
        32: 'from-pink-400 to-pink-200',
    };

    async function getBooks() {
        return fetch("{% url 'main:get_books' %}").then((res) => res.json());
    }

    async function buildFeaturedBooks(featured_books) {
        document.getElementById("featured_books").innerHTML = "";
        let htmlString = ``;
        featured_books.forEach((book) => {
            htmlString += `\n
            <div class="flex flex-row relative snap-center items-center hover:cursor-pointer rounded-xl transition shadow-md hover:shadow-xl w-[300px] lg:w-[400px] h-[200px] px-4 py-3 mx-1 gap-3 bg-gradient-to-t ${featured_book_colors[book.pk]}">
                <img src='media/${book.fields.cover_image}' class='w-[100px] rounded-lg drop-shadow-md'>
                <div class="flex-col w-[200px] lg:w-[300px]">
                    <div class="line-clamp-1 lg:line-clamp-2 font-bold text-md lg:text-lg text-white">${book.fields.name}</div>
                    <div class="line-clamp-1 text-white">By ${book.fields.author}</div>
                    <div class="h-[5px]"></div>
                    <div class="truncate text-white text-xs">${book.fields.genre}</div>
                    <div class="truncate text-white text-xs">${book.fields.original_language} - ${book.fields.year_published}</div>
                    <div class="flex flex-row gap-2">
                        {% for i in n %}
                            {% if i < 3 %}
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-[16px] h-[16px] fill-white bi bi-star-fill my-2" viewBox="0 0 16 16"> 
                                    <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/> 
                                </svg>
                            {% else %}
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-[16px] h-[16px] fill-gray-300 opacity-50 bi bi-star-fill my-2" viewBox="0 0 16 16"> 
                                    <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/> 
                                </svg>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>`.replaceAll('177013', book.pk)
        });
        
        document.getElementById("featured_books").innerHTML = htmlString;
    }

    async function buildBrowseBooks(books) {
        document.getElementById("browse_books").innerHTML = "";
        let htmlString = ``;
        books.forEach((book) => {
            htmlString += `\n
            <div class="flex flex-row items-center rounded-xl border transition shadow-md hover:shadow-xl w-[350px] sm:w-[250px] lg:w-[350px] h-[200px] px-4 py-3 gap-3 cursor-pointer">
                <img src='media/${book.fields.cover_image}' class='w-[100px] rounded-lg drop-shadow-md'>
                <div class="flex-col w-[250px] sm:w-[150px] lg:w-[250px]">
                    <div class="line-clamp-1 lg:line-clamp-2 font-semibold text-lg text-black">${book.fields.name}</div>
                    <div class="line-clamp-1 font-normal text-slate-400 text-sm">${book.fields.author}</div>
                    <div class="flex flex-row gap-2">
                        {% for i in n %}
                            {% if i < 3 %}
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-[16px] h-[16px] fill-yellow-400 bi bi-star-fill my-2" viewBox="0 0 16 16"> 
                                    <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/> 
                                </svg>
                            {% else %}
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-[16px] h-[16px] fill-gray-300 opacity-50 bi bi-star-fill my-2" viewBox="0 0 16 16"> 
                                    <path d="M3.612 15.443c-.386.198-.824-.149-.746-.592l.83-4.73L.173 6.765c-.329-.314-.158-.888.283-.95l4.898-.696L7.538.792c.197-.39.73-.39.927 0l2.184 4.327 4.898.696c.441.062.612.636.282.95l-3.522 3.356.83 4.73c.078.443-.36.79-.746.592L8 13.187l-4.389 2.256z"/> 
                                </svg>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>`.replaceAll('177013', book.pk)
        });
        
        document.getElementById("browse_books").innerHTML = htmlString;

        const hiddenElements = document.querySelectorAll("#card-book");
        console.log(hiddenElements);
        hiddenElements.forEach((element) => booksCardObserver.observe(element));
    }

    async function refreshBooks() {
        const books = await getBooks();
        const featured_books = books.filter(book => featured_book_ids.includes(book.pk));
        
        buildFeaturedBooks(featured_books);
        buildBrowseBooks(books);
    }

    function toggleDropdownUser() {
        const dropdownButton = document.getElementById("dropdown_user_button");
        const dropdownMenu = document.getElementById("dropdown_user_menu");
        
        dropdownMenu.classList.toggle('opacity-0');
        dropdownMenu.classList.toggle('scale-100');
        dropdownMenu.classList.toggle('scale-0');
    }

    function toggleDropdownGeneral() {
        const dropdownButton = document.getElementById("dropdown_general_button");
        const dropdownMenu = document.getElementById("dropdown_general_menu");

        dropdownMenu.classList.toggle('scale-100');
        dropdownMenu.classList.toggle('scale-0');
        dropdownMenu.classList.toggle('h-0');
    }
    
    let lastTime = -1;
    function searchBooks(value, searchTime) {
        lastTime = searchTime;
        setTimeout(async function() { // Make sure not to spam request to backend
            if (searchTime != lastTime) return;
            if (value && value != "") {
                const books = await fetch(`{% url 'main:get_books_by_name' 177013 %}`.replace(177013, value)).then((res) => res.json());
                buildBrowseBooks(books);
            } else {
                buildBrowseBooks(await getBooks());
            }
        }, 700);
    }

    const booksCardObserver = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
            console.log(entry);
            if (entry.isIntersecting) {
                entry.target.classList.remove('opacity-0');
                entry.target.classList.remove('blur-md');
                entry.target.classList.remove('translate-y-full');
                entry.target.classList.add('opacity-1');
                entry.target.classList.add('blur-none');
                entry.target.classList.add('translate-y-0');
            }
        });
    });

    const searchInput = document.getElementById("search_input");

    refreshBooks();
    searchInput.oninput = function(event) {
        searchBooks(event.target.value, event.timeStamp);
    };
</script>
{% endblock %}